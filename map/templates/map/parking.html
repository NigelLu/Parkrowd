{% extends "parkrowd/main.html" %}


{% block content %}
<style>
    #map {
        position: fixed !important; 
        bottom: 0; 
        height: 60vh; 
        width: 100%;
    }
</style>

<div id="map"></div>
<button id="load-parking-btn">Load Parking Spots</button>

<script>
    let map;
    let infowindow;
    const loadParkingBtn = document.getElementById("load-parking-btn");

    /**
     * Add markers on map with click-to-view info window
     * @param {Object} ParkingSpot - reference ParkingSpaceSerializer in api/serializers.py
     */
    function addMarker(spot) {
        let marker = new google.maps.Marker({
                position: {lat:parseFloat(spot.latitude), lng:parseFloat(spot.longitude)},
                map: map,
                title: spot.business_name
            });
            google.maps.event.addListener(marker, 'click', (function (marker, id) {
                return function () {
                    infowindow.setContent(spot.business_name);
                    infowindow.open(map, marker);
                }
            //TO DO : Change Marker ID from dca_license_number
            //to parking_spot_id
            //Jun will merge Meter Data Set
            })(marker, spot.dca_license_number));
    }

    function fetchParkingSpotAroundCenter() {

        const center = map.getCenter();
        const lat = center.lat();
        const lng = center.lng();

        axios.get(`/api/spots/?lat=${lat}&lon=${lng}`)
            .then(function (response) {
                // Process the API response data here
                const spotsData = response.data;
                spotsData.forEach(spot => {
                    addMarker(spot);
                })
            })
            .catch(function (error) {
                // Handle any errors here
                console.log("Error retrieving data");
                console.log(error);
            });
    }

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 40.69446042799896, lng: -73.9864403526369},
            zoom: 18
        });
        infowindow =  new google.maps.InfoWindow({});
    }

    loadParkingBtn.addEventListener('click', function(e) {
        fetchParkingSpotAroundCenter();
    })
   
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap"></script>
{% endblock %}